---
title: "time_series"
format: html
editor: visual
---

```{r, include =FALSE}
library(dplyr)
library(tidyverse)
library(lubridate)
library(readr)
library(here)
library(ggplot2)
library(stringr)
library(purrr)
library(maps)
library(knitr)
library(kableExtra)
library(sf)
library(RColorBrewer)
library(patchwork)
library(tmap)
library(viridis)
library(sp)
library(rworldmap)
library(rnaturalearth)
library(rnaturalearthdata)
library(scales)
library(tibble)
```

## Establishing File Paths

```{r}
#PATHS
#Time Series
discharge_path <- here("data", "discharge_time_series.csv")
ssc_path <- here("data", "sediment_time_series.csv")
chirps_path <- here("data", "chirps_time_series.csv")

#ZScores
discharge_z_path <- here("data", "discharge_zscore.csv")
ssc_z_path <- here("data", "sediment_zscore.csv")
chirps_z_path <- here("data", "chirps_zscore.csv")

#LOADING DATA 
#Time Series
discharge_ts <- read_csv(discharge_path, show_col_types = FALSE)
ssc_ts <- read_csv(ssc_path, show_col_types = FALSE)
chirps_ts <- read_csv(chirps_path, show_col_types = FALSE)

#ZScores 
discharge_z <- read_csv(discharge_z_path, show_col_types = FALSE)
ssc_z <- read_csv(ssc_z_path, show_col_types = FALSE)
chirps_z <- read_csv(chirps_z_path, show_col_types = FALSE)
```

## Figure 2 Time Series

### Mock Plot

```{r}
# -----------------------------
# 1) Fake data generator (reusable)
# -----------------------------
make_mock_site_df <- function(
  site = "JA.4.Kosi.2008.2008",
  start_year = 1985,
  end_year = 2020,
  avulsion_year = 2002,
  days_per_year = 365,
  seed = 7
) {
  set.seed(seed)

  years <- start_year:end_year
  rows <- vector("list", length(years))

  for (i in seq_along(years)) {
    y <- years[i]
    day <- 1:days_per_year
    x_year <- y + (day - 1) / days_per_year

    baseline <- rgamma(days_per_year, shape = 1.2, scale = 8)
    noise <- rnorm(days_per_year, mean = 0, sd = 3)
    ssc <- baseline + noise

    n_events <- sample(2:5, 1)
    for (k in seq_len(n_events)) {
      start <- sample(1:(days_per_year - 30), 1)
      duration <- sample(6:25, 1)

      t <- 0:(duration - 1)
      shape <- (t^2) * exp(-t / (duration / 5))
      shape <- shape / max(shape)

      peak <- if (runif(1) < 0.15) {
        rgamma(1, shape = 2.0, scale = 180)
      } else {
        rgamma(1, shape = 2.0, scale = 60)
      }

      end <- min(start + duration - 1, days_per_year)
      ssc[start:end] <- ssc[start:end] + peak * shape[seq_len(end - start + 1)]
    }

    if (runif(1) < 0.10) {
      extreme_day <- sample(1:(days_per_year - 2), 1)
      ssc[extreme_day:(extreme_day + 1)] <-
        ssc[extreme_day:(extreme_day + 1)] + rgamma(1, shape = 2.0, scale = 250)
    }

    ssc <- pmax(ssc, 0)

    rows[[i]] <- data.frame(
      site_name = site,
      year = x_year,
      value = ssc,                     # <-- generic column name for reuse
      avulsion_start_date = avulsion_year
    )
  }

  bind_rows(rows) |>
    filter(!is.na(year), !is.na(value)) |>
    arrange(year) |>
    mutate(year_int = floor(year))
}

# -----------------------------
# 2) Plot maker (returns ggplot) - patchwork ready
# -----------------------------
make_ts_plot <- function(
  site_df,
  avulsion_year,
  x_limits = c(1985, 2020),
  x_break_by = 5,
  y_label = "Metric (Discharge/SSC/Precip)",
  line_color = "#BDBDBDFF",
  shade_fill = "#fff7bc",
  show_shade = TRUE,
  show_peaks = TRUE
) {
  # Mean of annual 95th percentiles
  mean_p95 <- site_df %>%
    group_by(year_int) %>%
    summarise(p95 = quantile(value, probs = 0.95, na.rm = TRUE), .groups = "drop") %>%
    summarise(mean_p95 = mean(p95, na.rm = TRUE), .groups = "drop") %>%
    pull(mean_p95)

  annual_peaks <- site_df %>%
    group_by(year_int) %>%
    slice_max(value, n = 1, with_ties = FALSE) %>%
    ungroup() %>%
    mutate(in_window = year >= (avulsion_year - 1) & year <= avulsion_year)

  ymax <- max(site_df$value, na.rm = TRUE)

  p <- ggplot(site_df, aes(x = year, y = value))

  if (show_shade) {
    p <- p + annotate(
      "rect",
      xmin = avulsion_year - 1, xmax = avulsion_year,
      ymin = -Inf, ymax = Inf,
      fill = shade_fill, alpha = 0.6
    )
  }

  p <- p +
    geom_line(linewidth = 0.5, color = line_color) +
    geom_hline(
      yintercept = mean_p95,
      linetype = "dashed",
      linewidth = 0.5,
      color = "red"
    )

  if (show_peaks) {
    p <- p +
      geom_point(
        data = filter(annual_peaks, !in_window),
        aes(x = year, y = value),
        inherit.aes = FALSE,
        size = 1,
        color = "gray40",
        shape = 16
      ) +
      # "star" look via two layers in window
      geom_point(
        data = filter(annual_peaks, in_window),
        aes(x = year, y = value),
        inherit.aes = FALSE,
        size = 2,
        shape = 16,
        color = "dodgerblue",
        stroke = 1.2
      )
  }

  p +
    scale_x_continuous(
      limits = x_limits,
      breaks = seq(x_limits[1], x_limits[2], by = x_break_by),
      expand = c(0, 0)
    ) +
    scale_y_continuous(expand = c(0, 0)) +
    coord_cartesian(ylim = c(0, ymax * 1.2)) +
    labs(x = "Year", y = y_label) +
    theme_minimal(base_size = 12) +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      panel.grid.major.y = element_line(linetype = "dashed", linewidth = 0.25, color = "grey90"),
      axis.line = element_line(color = "black"),
      axis.ticks = element_line(color = "black"),
      legend.position = "none"
    )
}

# -----------------------------
# 3) Example: build three plots + patchwork them
# -----------------------------
site_df <- make_mock_site_df(
  site = "BETSIBOKA.2004",
  start_year = 1985,
  end_year = 2020,
  avulsion_year = 2002,
  seed = 7
)

p_mock <- make_ts_plot(site_df, avulsion_year = 2002)
p_mock

# Make sure this exists somewhere above:
plots_dir <- here::here("plots")
dir.create(plots_dir, showWarnings = FALSE, recursive = TRUE)

# Optional: a clean filename helper
safe_slug <- function(x) gsub("[^A-Za-z0-9_-]+", "_", x)

site_id <- unique(site_df$site_name)[1]
out_file <- file.path(
  plots_dir,
  paste0(safe_slug(site_id), "_MOCK_TS.png")
)

# Verify where you're saving
message("here() root: ", here::here())
message("Saving to:  ", normalizePath(plots_dir, winslash = "/", mustWork = FALSE))
message("File path:  ", normalizePath(out_file, winslash = "/", mustWork = FALSE))

# Actually save
ggsave(
  filename = out_file,
  plot = p_mock,
  width = 5,
  height = 5,
  units = "in",
  dpi = 300,
  bg = "white"
)

# Confirm it exists
message("File exists? ", file.exists(out_file))
```

### Sediment

```{r}

# -------------------------
# Paths
# -------------------------
av_year_updated_path <- here("data", "sediment_zscore.csv")
compiled_output_path <- here("data", "sediment_time_series.csv")
plots_dir <- "/Volumes/Crucial X6/paper_figures/rstudio/plots"

# -------------------------
# Load data
# -------------------------
av_year_updated <- read_csv(av_year_updated_path, show_col_types = FALSE)
compiled <- read_csv(compiled_output_path, show_col_types = FALSE)

compiled <- compiled %>%
  mutate(date = as.Date(date))

# -------------------------
# SELECT ONE SITE HERE
# -------------------------
site <- "B6"

site_df <- compiled %>%
  filter(site_name == site) %>%
  arrange(date)

stopifnot(nrow(site_df) > 0)

# -------------------------
# Avulsion shading window
# -------------------------
avs <- if ("avulsion_start_date" %in% names(site_df)) {
  site_df %>%
    pull(avulsion_start_date) %>%
    as.numeric() %>%
    na.omit() %>%
    unique()
} else {
  numeric(0)
}

shade_df <- NULL
if (length(avs) > 0) {
  shade_df <- tibble(
    xmin = as.Date(paste0(avs[1] - 1, "-01-01")),
    xmax = as.Date(paste0(avs[1], "-12-31")),
    ymin = -Inf,
    ymax = Inf
  )
}

# -------------------------
# Mean 95th percentile line (from zscore table)
# -------------------------
year_p95 <- av_year_updated %>%
  filter(site_name == site) %>%
  pull(p95_mean) %>%
  first()

# -------------------------
# 95th percentile value within the shaded window,
# plotted at the exact date of the maximum within the window
# -------------------------
p95_pt <- NULL

if (!is.null(shade_df)) {
  window_df <- site_df %>%
    filter(date >= shade_df$xmin, date <= shade_df$xmax) %>%
    filter(!is.na(y_pred))

  if (nrow(window_df) > 0) {
    p95_val <- as.numeric(quantile(window_df$y_pred, probs = 0.95, na.rm = TRUE, type = 7))

    max_row <- window_df %>%
      filter(y_pred == max(y_pred, na.rm = TRUE)) %>%
      arrange(date) %>%   # if ties, use earliest max date
      slice(1)

    p95_pt <- tibble(
      date = max_row$date,
      y_pred = p95_val
    )
  }
}

# -------------------------
# Plot
# -------------------------
p_ssc <- ggplot(site_df, aes(x = date, y = y_pred)) +

  # Avulsion shading
  {if (!is.null(shade_df))
    geom_rect(
      data = shade_df,
      aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
      inherit.aes = FALSE,
      fill = "#fff7bc",
      alpha = 0.6
    )
  } +
  
    # Mean p95 line
  {if (!is.na(year_p95))
    geom_hline(
      yintercept = year_p95,
      linetype = "dashed",
      color = "black",
      linewidth = 0.75,
      alpha = 0.75
    )
  } +

  # Time series
  geom_point(color = "grey30", size = 0.35) +
  geom_line(color = "grey30", linewidth = 0.35) +

  # Blue point: y = p95(window), x = date of max(window)
  {if (!is.null(p95_pt))
  ggstar::geom_star(
    data = p95_pt,
    aes(x = date, y = y_pred),
    inherit.aes = FALSE,
    starshape = 1,     # five-point star
    fill = "#FEC44F",
    color = "grey30",
    size = 5
  )
} + 

  # Axes (keep only scale_x_date to avoid scale replacement warnings)
  scale_x_date(
    limits = as.Date(c("1985-01-01", "2020-12-31")),
    breaks = seq(as.Date("1985-01-01"),
                 as.Date("2020-01-01"),
                 by = "5 years"),
    labels = date_format("%Y"),
    expand = c(0, 0)
  ) +
  scale_y_continuous(expand = c(0, 0)) +

  labs(
    x = "Year",
    y = "SSC (mg/L)"
  ) +

  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_line(
      linetype  = "solid",
      linewidth = 0.25,
      color = "grey90"),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.text.x = element_text(face = "bold", color = "grey30"),
    axis.text.y = element_text(face = "bold", color = "grey30"),
    axis.title.x = element_text(face = "bold", color = "grey30"),
    axis.title.y = element_text(face = "bold", color = "grey30")
  )

# -------------------------
# Save
# -------------------------
safe_name <- site %>%
  str_replace_all(" ", "_") %>%
  str_replace_all("/", "_")

ggsave(
  filename = file.path(plots_dir, paste0(safe_name, "_ssc_timeseries.png")),
  plot = p_ssc,
  width = 10,
  height = 4,
  dpi = 300
)

p_ssc


```

### Discharge

```{r}
# Paths
av_year_path  <- here("data", "discharge_zscore.csv")
compiled_path <- here("data", "discharge_time_series.csv")
plots_dir     <- "/Volumes/Crucial X6/paper_figures/rstudio/plots"

dir.create(plots_dir, recursive = TRUE, showWarnings = FALSE)

# Read data
compiled        <- read_csv(compiled_path, show_col_types = FALSE)
av_year_updated <- read_csv(av_year_path, show_col_types = FALSE)

# Parse datetime
compiled <- compiled %>%
  mutate(valid_time = as.POSIXct(valid_time, tz = "UTC"))

xmin <- as.POSIXct("1985-01-01", tz = "UTC")
xmax <- as.POSIXct("2020-12-31", tz = "UTC")

# -------------------------
# CHOOSE ONE SITE HERE
# -------------------------
site <- "B6"

site_df <- compiled %>%
  filter(site_name == site) %>%
  arrange(valid_time)

stopifnot(nrow(site_df) > 0)

# ---- Avulsion shading window (if column exists + has a value) ----
avs <- if ("avulsion_start_date" %in% names(site_df)) {
  site_df %>%
    pull(avulsion_start_date) %>%
    as.numeric() %>%
    na.omit() %>%
    unique()
} else {
  numeric(0)
}

shade_df <- NULL
if (length(avs) > 0) {
  shade_df <- tibble(
    xmin = as.POSIXct(paste0(avs[1] - 1, "-01-01"), tz = "UTC"),
    xmax = as.POSIXct(paste0(avs[1], "-12-31"), tz = "UTC"),
    ymin = -Inf,
    ymax = Inf
  )
}

# ---- Mean 95th percentile line for this site (from zscore table) ----
year_p95 <- av_year_updated %>%
  filter(site_name == site) %>%
  pull(p95_mean) %>%
  first()

# ---- 95th percentile point within shaded window (x = date of max in window) ----
p95_pt <- NULL

if (!is.null(shade_df)) {
  window_df <- site_df %>%
    filter(valid_time >= shade_df$xmin, valid_time <= shade_df$xmax) %>%
    filter(!is.na(dis24))

  if (nrow(window_df) > 0) {
    # window-specific 95th percentile value
    p95_val <- as.numeric(quantile(window_df$dis24, probs = 0.95, na.rm = TRUE, type = 7))

    # exact date of maximum discharge within the window (tie-break: earliest)
    max_row <- window_df %>%
      filter(dis24 == max(dis24, na.rm = TRUE)) %>%
      arrange(valid_time) %>%
      slice(1)

    # plot p95 value at the max date
    p95_pt <- tibble(
      valid_time = max_row$valid_time,
      dis24      = p95_val
    )
  }
}

# ---- Plot ----
p_dis <- ggplot(site_df, aes(x = valid_time, y = dis24)) +

  # Avulsion shading
  {if (!is.null(shade_df))
    geom_rect(
      data = shade_df,
      aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
      inherit.aes = FALSE,
      fill = "#fff7bc",
      alpha = 0.6
    )
  } +
  
    # Mean p95 line
  {if (!is.na(year_p95))
    geom_hline(
      yintercept = year_p95,
      color = "black",
      linetype = "dashed",
      linewidth = 0.75,
      alpha = 0.75
    )
  } +

  # Base line
  geom_point(color = "grey30", size = 0.35) +
  geom_line(color = "grey30", linewidth = 0.35) +

  # Blue point: y = p95(window), x = date of max(window)
  {if (!is.null(p95_pt))
  ggstar::geom_star(
    data = p95_pt,
    aes(x = valid_time, y = dis24),
    inherit.aes = FALSE,
    starshape = 1,     # five-point star
    fill = "#FEC44F",
    color = "grey30",
    size = 5
  )
} +

  scale_y_continuous(expand = c(0, 0)) +

  # Date ticks + limits (add expand here; drop scale_x_continuous to avoid scale conflicts)
  scale_x_datetime(
    limits = c(xmin, xmax),
    breaks = seq(xmin, xmax, by = "5 years"),
    labels = date_format("%Y"),
    expand = c(0, 0)
  ) +

  labs(
    x = "Year",
    y = "Discharge (mÂ³/s)"
  ) +

  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_line(linetype = "solid", linewidth = 0.20, color = "grey90"),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.text.x = element_text(face = "bold", color = "grey30"),
    axis.text.y = element_text(face = "bold", color = "grey30"),
    axis.title.x = element_text(face = "bold", color = "grey30"),
    axis.title.y = element_text(face = "bold", color = "grey30")
  )

# ---- Save (one file) ----
safe <- site %>%
  as.character() %>%
  str_replace_all(" ", "_") %>%
  str_replace_all("/", "_")

ggsave(
  filename = file.path(plots_dir, paste0(safe, "_dis24_timeseries.png")),
  plot = p_dis,
  width = 10,
  height = 4,
  dpi = 200
)

# Print the plot in RStudio/Quarto
p_dis



```

### Precipitation

```{r}
av_year_path  <- here("data", "chirps_zscore.csv")
compiled_path <- here("data", "chirps_time_series.csv")
plots_dir     <- "/Volumes/Crucial X6/paper_figures/rstudio/plots"
compiled        <- read_csv(compiled_path, show_col_types = FALSE)
av_year_updated <- read_csv(av_year_path, show_col_types = FALSE)

make_precip_ts_plot <- function(
  site,
  compiled,
  av_year_updated,
  xmin = as.POSIXct("1985-01-01", tz = "UTC"),
  xmax = as.POSIXct("2020-12-31", tz = "UTC"),
  line_color = "#525252FF",
  shade_fill = "#fff7bc"
) {

  # Make a safe datetime column (prevents arrange(date) grabbing a function)
  df <- compiled |>
    filter(.data$site_name == site) |>
    mutate(date_posix = as.POSIXct(.data$date, tz = "UTC")) |>
    arrange(.data$date_posix)

  if (nrow(df) == 0) {
    warning("No data for site: ", site)
    return(NULL)
  }

  # Limit to plotting window to avoid "Removed rows ... outside scale range"
  df_plot <- df |>
    filter(.data$date_posix >= xmin, .data$date_posix <= xmax)

  # --- Avulsion year (first unique value) ---
  av_year <- df_plot |>
    pull(.data$avulsion_start_date) |>
    as.numeric() |>
    na.omit() |>
    unique()

  av_year <- if (length(av_year) > 0) av_year[1] else NA_real_

  # --- Mean p95 line (from zscores table) ---
  year_p95 <- av_year_updated |>
    filter(.data$site_name == site) |>
    pull(.data$p95_mean)

  year_p95 <- if (length(year_p95) > 0) year_p95[1] else NA_real_

  # --- Window-specific p95 point (x = date of max in window) ---
  p95_pt <- NULL

  if (!is.na(av_year)) {
    win_xmin <- as.POSIXct(paste0(av_year - 1, "-01-01"), tz = "UTC")
    win_xmax <- as.POSIXct(paste0(av_year, "-12-31"), tz = "UTC")

    window_df <- df_plot |>
      filter(.data$date_posix >= win_xmin, .data$date_posix <= win_xmax) |>
      filter(!is.na(.data$precip))

    if (nrow(window_df) > 0) {
      p95_val <- as.numeric(quantile(window_df$precip, probs = 0.95, na.rm = TRUE, type = 7))

      max_row <- window_df |>
        filter(.data$precip == max(.data$precip, na.rm = TRUE)) |>
        arrange(.data$date_posix) |>
        slice(1)

      p95_pt <- tibble(
        date_posix = max_row$date_posix,
        precip    = p95_val
      )
    }
  }

  # --- Plot ---
  p <- ggplot(df_plot, aes(x = .data$date_posix, y = .data$precip)) +

    # Avulsion shading
    {if (!is.na(av_year))
      annotate(
        "rect",
        xmin = as.POSIXct(paste0(av_year - 1, "-01-01"), tz = "UTC"),
        xmax = as.POSIXct(paste0(av_year, "-12-31"), tz = "UTC"),
        ymin = -Inf, ymax = Inf,
        fill = shade_fill, alpha = 0.6
      )
    } +

    geom_line(color = line_color, linewidth = 0.5) +

    # Blue point (p95 in window at date of max in window)
    {if (!is.null(p95_pt))
      geom_point(
        data = p95_pt,
        aes(x = .data$date_posix, y = .data$precip),
        inherit.aes = FALSE,
        color = "dodgerblue3",
        size = 2.2
      )
    } +

    # Mean p95 line
    {if (!is.na(year_p95))
      geom_hline(
        yintercept = year_p95,
        color = "red",
        linetype = "dashed",
        linewidth = 0.25
      )
    } +

    scale_x_datetime(
      limits = c(xmin, xmax),
      breaks = seq(xmin, xmax, by = "5 years"),
      labels = date_format("%Y"),
      expand = c(0, 0)
    ) +
    scale_y_continuous(expand = c(0, 0)) +
    labs(
      title = paste(site, ": Precipitation Time Series"),
      x = "Year",
      y = "Precipitation (mm/month)"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      panel.grid.major.y = element_line(linetype = "solid", linewidth = 0.25, color = "grey90"),
      axis.line = element_line(color = "black"),
      axis.ticks = element_line(color = "black"),
      legend.position = "none"
    )

  p
}

p_precip <- make_precip_ts_plot(
  site     = "BETSIBOKA.2004",
  compiled = compiled,
  av_year_updated  = av_year_updated
)

# Explicit print (important inside functions / Quarto)
print(p_precip)

ggsave(
  filename = here("plots", "chirps_timeseries_BETSIBOKA_2004.png"),
  plot     = p_precip,
  width    = 10,
  height   = 4,
  units    = "in",
  dpi      = 300
)


```

```{r}

(p1 + p2) / (p3 + p4)
# or specify the layout directly
p1 + p2 + p3 + p4 + plot_layout(ncol = 2, nrow = 2)
```
